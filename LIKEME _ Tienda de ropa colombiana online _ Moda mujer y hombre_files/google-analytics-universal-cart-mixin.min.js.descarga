define(['jquery','mage/utils/wrapper','Magento_Customer/js/customer-data','Lineadirecta_GoogleTagManager/js/model/google-tag-manager-data-resolver','Magento_Customer/js/action/login','mage/cookies',],function($,wrapper,customerData,googleTagManagerDataResolver,loginAction){'use strict';function delCookie(name){var date=new Date(0);document.cookie=name+'='+'; path=/; expires='+date.toUTCString();}
return function(GoogleAnalyticsUniversalCart){GoogleAnalyticsUniversalCart.prototype.updateCartObserver=function(){this.collectCustomerProducts();this.collectProductsWithChanges();this.collectProductsForMessages();this.cartItemAdded();this.cartItemRemoved();};GoogleAnalyticsUniversalCart.prototype.collectProductsForMessages=function(){var i=0,product,item
this.addedProducts=[];this.removedProducts=[];for(i;i<this.productWithChanges.length;i++){product=this.productWithChanges[i];if(!_.isUndefined(this.origProducts[product.id])){if(product.qty>this.origProducts[product.id].qty){product.qty=Math.abs(product.qty-this.origProducts[product.id].qty);item=googleTagManagerDataResolver.prepareItemData(product['item']);item.quantity=product.qty;this.addedProducts.push(item);}else if(product.qty<this.origProducts[product.id].qty){product.qty=Math.abs(this.origProducts[product.id].qty-product.qty);item=googleTagManagerDataResolver.prepareItemData(product['item']);item.quantity=product.qty;this.removedProducts.push(item);}}}};GoogleAnalyticsUniversalCart.prototype.collectOriginalProducts=function(){var products={},items=customerData.get('cart')().items;if(!_.isUndefined(items)){items.forEach(function(item){var qty=$('input[data-cart-item-id='+item['product_sku']+']').data('item-qty')||item.qty;products[item['product_sku']]={'id':item['product_sku'],'name':item['product_name'],'price':item['product_price_value'],'qty':parseInt(qty,10),'item':item};});}
this.googleAnalyticsUniversalData.shoppingCartContent=products;this.origProducts=this.googleAnalyticsUniversalData.shoppingCartContent;};GoogleAnalyticsUniversalCart.prototype.cartItemAdded=function(){if(!this.addedProducts.length){return;}
this.dataLayer.push({'userid':googleTagManagerDataResolver.getUserId(),'event':'add_to_cart','ecommerce':{'currency':this.dlCurrencyCode,'items':this.addedProducts}});this.addedProducts=[];}
GoogleAnalyticsUniversalCart.prototype.cartItemRemoved=function(){if(!this.removedProducts.length){return;}
this.dataLayer.push({'userid':googleTagManagerDataResolver.getUserId(),'event':'remove_from_cart','ecommerce':{'currencyCode':this.dlCurrencyCode,'items':this.removedProducts}});this.removedProducts=[];};GoogleAnalyticsUniversalCart.prototype.loggedInFromCookies=function(){var context=this;if($.cookie('ga_login_post')){var loginPostData=JSON.parse(decodeURIComponent($.cookie('ga_login_post')));this.dataLayer.push({'event':'interactive','event_category':'inicio sesion | '+loginPostData['frontend_area'],'event_action':'login','event_label':loginPostData['status'],'userid':loginPostData['email_hashed']});delCookie('ga_login_post');}else{loginAction.registerLoginCallback(function(loginData){context.loggedInFromCookies();});}};GoogleAnalyticsUniversalCart.prototype.forgotPasswordFromCookies=function(){if($.cookie('ga_forgot_password_post')){var data=JSON.parse(decodeURIComponent($.cookie('ga_forgot_password_post')));this.dataLayer.push({'event':'interactive','event_category':'olvidar contraseÃ±a','event_action':'restablecer formulario','event_label':data['status']});delCookie('ga_forgot_password_post');}};GoogleAnalyticsUniversalCart.prototype.createAccountFromCookies=function(){if($.cookie('ga_create_account_post')){var data=JSON.parse(decodeURIComponent($.cookie('ga_create_account_post')));this.dataLayer.push({'event':'interactive','event_category':'registro | '+data['frontend_area'],'event_action':'formulario registro','event_label':data['status']});delCookie('ga_create_account_post');}};GoogleAnalyticsUniversalCart.prototype.layeredNavigation=function(){var self=this;$('.filter-options-item:not(.cat)').on('click','.item a',function(event){var element=$(event.currentTarget);var label=element.find('label span').eq(0).text();self.clickFilter(element,label);});$('.filter-options-item .swatch-attribute-options').on('click','a',function(event){var element=$(event.currentTarget);var label=element.find('.swatch-option').data('option-label');self.clickFilter(element,label);});};GoogleAnalyticsUniversalCart.prototype.searchResult=function(){var self=this;const listBoxClasses=['list-term','list-product','list-category'];$('#search_mini_form').on('smile:OptionSelect submit',function(event,option){var listBoxClass,eventAction,eventLabel,formSearchInput=$('#search_mini_form').find('#search').val(),isPushedDl=false,element;if(option){element=$(option.currentTarget);var listBoxParent=element.parents('.autocomplete-list');listBoxClasses.forEach(function(item){if(listBoxParent.hasClass(item)){listBoxClass=item;}});console.log("click",isPushedDl);}else{element=$(event.currentTarget);if(element.find('dd.selected').length||element.hasClass('submitted')){isPushedDl=true;}}
switch(listBoxClass){case'list-product':eventAction='categoria';eventLabel=[formSearchInput,element.find('.product-name').text(),'productos'];break;case'list-category':eventAction='categoria';eventLabel=[formSearchInput,element.find('span.qs-option-name').text(),'categoria'];break;case'list-term':eventAction='termino';eventLabel=[formSearchInput,element.find('span.qs-option-name').text(),'lo mas buscado'];break;default:eventAction='termino';eventLabel=formSearchInput;}
var label=eventLabel instanceof Array?eventLabel.join('|'):eventLabel
if(!isPushedDl){self.dataLayer.push({'event':'interactive','event_category':'buscador','event_action':eventAction,'event_label':label});if(element.hasClass('form minisearch')){element.addClass('submitted');}}});};GoogleAnalyticsUniversalCart.prototype.clickFilter=function(filter,action){if(filter&&!filter.data('ga-filter-selected')){var parent=filter.parents('.filter-options-item');this.dataLayer.push({'event':'interactive','event_category':'filtro producto','event_action':'filtrar por - '+parent.find('.filter-options-title').text(),'event_label':action});filter.data('ga-filter-selected',true);}}
GoogleAnalyticsUniversalCart.prototype.couponCodesHandler=function(){if($.cookie('ga_create_coupon_post')){var data=JSON.parse(decodeURIComponent($.cookie('ga_create_coupon_post')));this.dataLayer.push({'event':'interactive','event_category':data['frontend_area'],'event_action':data['action']+'_bono','event_label':[data['status'],data['coupon_code']].join('-')});delCookie('ga_create_coupon_post');}}
GoogleAnalyticsUniversalCart.prototype.newsletterSubscribeHandler=function(){if($.cookie('ga_newsletter_save')){var data=JSON.parse(decodeURIComponent($.cookie('ga_newsletter_save')));this.dataLayer.push({'event':'interactive','event_category':'zona usuario newsletter','event_action':data['status']+' suscripcion','event_label':'guardar'});delCookie('ga_newsletter_save');}}
GoogleAnalyticsUniversalCart.prototype.socialClickHandler=function(){var self=this;$('#product-social-networks').find('.share-link a').on('click',function(e){var element=$(e.currentTarget),shareTo=element.attr("title"),category=$('.product-item-brand').find('.brand-image img:first').attr('alt'),productName=$('.product-info-container').find('.page-title-wrapper span[itemprop="name"]').text(),productSku=$('.product-info-container').find('.product-info-stock-sku div[itemprop="sku"]').text();self.dataLayer.push({'event':'interactive','event_category':'detalle producto','event_action':'compartir - '+shareTo,'event_label':productSku+'|'+category+'|'+productName});});}
return GoogleAnalyticsUniversalCart;};});